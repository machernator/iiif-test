var DownloadMenu={imageUrlTemplate:Mirador.Handlebars.compile("{{imageBaseUrl}}/full/{{size}}/0/default.jpg"),menuTemplate:Mirador.Handlebars.compile(['<span class="mirador-btn mirador-icon-download" role="button" title="Download">','<i class="fa fa-download fa-lg fa-fw"></i>','<i class="fa fa-caret-down"></i>','<ul class="dropdown download-list">','<li title="IIIF-Manifest"><a href="{{manifestUrl}}" target="_blank">','<i class="fa fa-file-text-o fa-lg fa-fw"></i>IIIF-Manifest',"</a></li>","{{#each imageUrls}}",'<li class="{{#if (eq this "#")}}disabled {{/if}}image-link" title="JPG ({{this.title}})">','<a href="{{this.href}}" target="_blank">','<i class="fa fa-file-image-o fa-lg fa-fw"></i>JPG (<span class="dimensions">{{this.title}}</span>)',"</a></li>","{{/each}}","</ul>","</span>"].join("")),sizes:["full","250,"],extractImageUrls:function(i){var e=i.focusModules.ImageView.currentImgIndex;"right-to-left"===i.manifest.jsonLd.viewingDirection&&(e=i.manifest.jsonLd.sequences[0].canvases.length-e);var n=i.imagesList[e],t=Mirador.Iiif.getImageUrl(n),a=n.height/n.width,s=[];return this.sizes.forEach(function(e){s.push({href:"ImageView"!==i.currentImageMode?"#":this.imageUrlTemplate({imageBaseUrl:t,size:e}),title:"full"===e?n.width+"x"+n.height:parseInt(e)+"x"+Math.ceil(parseInt(e)*a)})}.bind(this)),s},init:function(){Mirador.Handlebars.registerHelper("eq",function(i,e){return i===e}),this.injectWindowEventHandler(),this.injectWorkspaceEventHandler()},injectMenuToNavigation:function(i,e,n){$(i).prepend(this.menuTemplate({imageUrls:n,manifestUrl:e}))},injectWindowEventHandler:function(){var i=this,e=Mirador.Window.prototype.bindNavigation;Mirador.Window.prototype.bindNavigation=function(){e.apply(this),this.element.find(".window-manifest-navigation").on("mouseenter",".mirador-icon-download",function(){this.element.find(".download-list").stop().slideFadeToggle(300)}.bind(this)).on("mouseleave",".mirador-icon-download",function(){this.element.find(".download-list").stop().slideFadeToggle(300)}.bind(this))};var n=Mirador.Window.prototype.bindEvents;Mirador.Window.prototype.bindEvents=function(){n.apply(this),this.eventEmitter.subscribe("windowUpdated",function(e,n){if(this.id===n.id&&n.viewType){if(0===this.element.find(".mirador-icon-download").length){var t=this.manifest.jsonLd["@id"],a=this.element.find(".window-manifest-navigation");i.injectMenuToNavigation(a,t,i.sizes.reduce(function(i){return i.push({href:"#",title:"n.a."}),i},[]))}if("ImageView"===n.viewType){var s=i.extractImageUrls(this);this.element.find(".image-link").removeClass("disabled").attr("title",function(i){return"JPG ("+s[i].title+")"}).find("a").attr("href",function(i){return s[i].href}).find("span.dimensions").text(function(i){return s[i].title})}else this.element.find(".image-link").addClass("disabled").find("span.dimensions").text("n.a.")}}.bind(this))}},injectWorkspaceEventHandler:function(){var i=this,e=Mirador.Workspace.prototype.bindEvents;Mirador.Workspace.prototype.bindEvents=function(){e.apply(this),this.eventEmitter.subscribe("windowAdded",function(e,n){var t=this.windows.filter(function(i){return i.id===n.id})[0],a=t.manifest.jsonLd["@id"],s=i.extractImageUrls(t),o=t.element.find(".window-manifest-navigation");i.injectMenuToNavigation(o,a,s)}.bind(this))}}};$(document).ready(function(){DownloadMenu.init()});