"use strict";let fields=Object.create(null);function init(e){const t=e.dataset.idprefix;if(fields[t]=Object.create(null),fields[t].id=t,fields[t].el=e,fields[t].url=e.dataset.searchurl,fields[t].searchField=e.querySelector(`[data-id=${t}Search]`),fields[t].results=e.querySelector(`[data-id=${t}Results]`),fields[t].selectedElemsWrapper=e.querySelector(`[data-id=${t}Selection]`),fields[t].btnClear=e.querySelector(`[data-id=${t}Clear]`),fields[t].btnClearSearch=e.querySelector(".btn-clearsearch"),fields[t].formField=e.querySelector(`[data-id=${t}]`),fields[t].searchResultsWrapper=e.querySelector(".nhm-search-wrapper"),fields[t].searchResultsWrapper.style.display="none",fields[t].selectedData=[],fields[t].singleChoice=!(!e.dataset.choice||"single"!=e.dataset.choice),fields[t].selectedElemsWrapper){const e=fields[t].selectedElemsWrapper.querySelectorAll("li"),s=fields[t].selectedData;e.forEach((e=>{const t=e.dataset.entryid,l=e.dataset.text;s.push({id:t,text:l})})),updateSelectionField(fields[t])}fields[t].btnClear.addEventListener("click",(e=>{fields[t].searchField.value="",clearChildren(fields[t].results),fields[t].searchResultsWrapper.style.display="none"})),fields[t].btnClearSearch.addEventListener("click",(e=>{fields[t].searchField.value="",clearChildren(fields[t].results),fields[t].searchResultsWrapper.style.display="none"})),fields[t].searchField.addEventListener("keyup",(function(e){const s=this.value,l=this.closest("[data-idprefix]").dataset.idprefix,i=fields[l];if(s.length<2)return clearChildren(i.results),void(fields[t].searchResultsWrapper.style.display="none");clearTimeout(window.searchTimeoutFinished),window.searchTimeoutFinished=setTimeout((function(){getResults(i)}),800)})),fields[t].searchField.addEventListener("keydown",(function(e){"Enter"!==e.key||e.preventDefault()})),fields[t].results.addEventListener("click",(function(e){const s=e.target,l=s.closest("[data-idprefix]").dataset.idprefix,i=s.closest("li");if(i&&i.dataset.noclick)return e.preventDefault(),!1;const a=i.dataset.entrytext,d=i.dataset.entryid;for(const e in fields[l].selectedData)if(d===fields[l].selectedData[e].id)return;fields[l].singleChoice?fields[l].selectedData=[{id:d,text:a}]:fields[l].selectedData.push({id:d,text:a}),updateSelection(fields[l]),fields[t].searchField.value="",clearChildren(fields[t].results),fields[t].searchField.focus()})),fields[t].selectedElemsWrapper.addEventListener("click",(function(e){const t=e.target;t.classList.contains("btn-close")&&deleteEntry(t)}))}function getResults(e){window.showLoadingAnimation(e.searchField);const t=new FormData;t.append("token",csrftoken),t.append("search",e.searchField.value),e.searchResultsWrapper.style.display="block";fetch(e.url,{method:"post",body:t}).then((e=>e.json())).then((t=>{window.hideLoadingAnimation(e.searchField),updateResults(e,t)}))}function updateResults(e,t){const s=e.results;clearChildren(s);let l=document.createDocumentFragment();if(0==t.length){let e=document.createElement("li");e.className="alert-warning",e.innerText="No results were found.",e.setAttribute("data-noclick",!0),l.appendChild(e)}else for(const e in t){let s=document.createElement("li");const i=t[e];s.setAttribute("data-entryid",i.id),s.setAttribute("data-entrytext",i.text);const a=document.createTextNode(i.text);if(s.appendChild(a),void 0!==i.count){const e=document.createElement("span");e.className="badge bg-secondary px-2 py-1 ms-3 rounded-pill",e.innerText=i.count,s.appendChild(e)}l.appendChild(s)}s.appendChild(l)}function updateSelection(e){const t=e.selectedElemsWrapper;if(clearChildren(t),e.selectedData.length>0){let s=document.createDocumentFragment();e.selectedData.forEach((function(e){const t=document.createElement("li");t.setAttribute("data-entryid",e.id),t.setAttribute("data-text",e.text);const l=document.createElement("button");l.setAttribute("type","button"),l.className="btn btn-sm btn-close",l.setAttribute("data-entryid",e.id),t.append(l,e.text),s.append(t)})),t.appendChild(s)}updateSelectionField(e)}function updateSelectionField(e){let t="",s="";e.selectedData.forEach((function(e){t+=s+e.id,s=","})),e.formField.value=t}function deleteEntry(e){const t=fields[e.closest("[data-idprefix]").dataset.idprefix],s=e.dataset.entryid,l=t.selectedData;for(const e in l){l[e].id==s&&(l.splice(e,1),updateSelection(t))}}function clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}const nhmDataSearch={init:init};window.nhmDataSearch=nhmDataSearch;export{nhmDataSearch as default};